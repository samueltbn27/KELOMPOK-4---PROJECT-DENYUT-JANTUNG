<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monitoring Detak Jantung - MAX30102</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .dashboard {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .card-full {
        grid-column: 1 / -1;
      }

      .bpm-display {
        text-align: center;
      }

      .heart-icon {
        font-size: 60px;
        color: #e74c3c;
        animation: heartbeat 1.5s ease-in-out infinite;
      }

      @keyframes heartbeat {
        0%,
        100% {
          transform: scale(1);
        }
        25% {
          transform: scale(1.1);
        }
        50% {
          transform: scale(1);
        }
      }

      #bpmValue {
        font-size: 72px;
        font-weight: bold;
        margin: 20px 0;
        color: #2c3e50;
      }

      .bpm-label {
        font-size: 18px;
        color: #7f8c8d;
        text-transform: uppercase;
        letter-spacing: 2px;
      }

      .status-box {
        margin-top: 20px;
        padding: 15px;
        border-radius: 10px;
        font-size: 18px;
        font-weight: bold;
      }

      .status-normal {
        background: #2ecc71;
        color: white;
      }

      .status-low {
        background: #3498db;
        color: white;
      }

      .status-high {
        background: #e67e22;
        color: white;
      }

      .status-danger {
        background: #e74c3c;
        color: white;
        animation: blink 1s infinite;
      }

      @keyframes blink {
        0%,
        50%,
        100% {
          opacity: 1;
        }
        25%,
        75% {
          opacity: 0.5;
        }
      }

      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 20px;
      }

      .info-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
      }

      .info-item .label {
        font-size: 12px;
        color: #7f8c8d;
        text-transform: uppercase;
        margin-bottom: 5px;
      }

      .info-item .value {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
      }

      .chart-container {
        position: relative;
        height: 300px;
        margin-top: 20px;
      }

      .card h2 {
        color: #2c3e50;
        margin-bottom: 20px;
        font-size: 24px;
        border-bottom: 3px solid #667eea;
        padding-bottom: 10px;
      }

      .sensor-status {
        display: flex;
        justify-content: space-around;
        margin-top: 20px;
      }

      .sensor-indicator {
        text-align: center;
      }

      .indicator-light {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin: 0 auto 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 30px;
      }

      .indicator-light.active {
        box-shadow: 0 0 20px rgba(46, 204, 113, 0.8);
      }

      .led-indicator {
        background: #95a5a6;
      }

      .led-indicator.on {
        background: #f39c12;
        box-shadow: 0 0 20px rgba(243, 156, 18, 0.8);
      }

      .buzzer-indicator {
        background: #95a5a6;
      }

      .buzzer-indicator.on {
        background: #e74c3c;
        box-shadow: 0 0 20px rgba(231, 76, 60, 0.8);
      }

      .connection-status {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 14px;
        margin-top: 10px;
      }

      .connected {
        background: #2ecc71;
        color: white;
      }

      .disconnected {
        background: #e74c3c;
        color: white;
      }

      #waktu {
        font-size: 16px;
        color: #7f8c8d;
        margin-top: 10px;
      }

      .stats-container {
        display: flex;
        justify-content: space-around;
        margin-top: 20px;
      }

      .stat-box {
        text-align: center;
        flex: 1;
      }

      .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #667eea;
      }

      .stat-label {
        font-size: 14px;
        color: #7f8c8d;
        margin-top: 5px;
      }

      @media (max-width: 768px) {
        .dashboard {
          grid-template-columns: 1fr;
        }

        .card-full {
          grid-column: 1;
        }

        .header h1 {
          font-size: 1.8em;
        }

        #bpmValue {
          font-size: 56px;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h1>
          <i class="fas fa-heartbeat"></i> Monitoring Detak Jantung Real-time
        </h1>
        <p>Sistem Deteksi Detak Jantung dengan Sensor MAX30102</p>
        <span class="connection-status" id="connectionStatus">
          <i class="fas fa-circle"></i> Menghubungkan...
        </span>
      </div>

      <div class="dashboard">
        <!-- BPM Display Card -->
        <div class="card bpm-display">
          <div class="heart-icon">
            <i class="fas fa-heart"></i>
          </div>
          <div class="bpm-label">Detak Jantung</div>
          <div id="bpmValue">--</div>
          <div class="bpm-label">BPM</div>
          <div id="statusBox" class="status-box status-normal">Normal</div>
          <div id="waktu">Menunggu data...</div>
        </div>

        <!-- Statistics Card -->
        <div class="card">
          <h2><i class="fas fa-chart-line"></i> Statistik</h2>
          <div class="info-grid">
            <div class="info-item">
              <div class="label">Minimum</div>
              <div class="value" id="minBpm">--</div>
            </div>
            <div class="info-item">
              <div class="label">Maximum</div>
              <div class="value" id="maxBpm">--</div>
            </div>
            <div class="info-item">
              <div class="label">Rata-rata</div>
              <div class="value" id="avgBpm">--</div>
            </div>
            <div class="info-item">
              <div class="label">Total Data</div>
              <div class="value" id="totalData">0</div>
            </div>
          </div>

          <div class="sensor-status">
            <div class="sensor-indicator">
              <div class="indicator-light led-indicator" id="ledIndicator">
                <i class="fas fa-lightbulb"></i>
              </div>
              <div>LED Status</div>
            </div>
            <div class="sensor-indicator">
              <div
                class="indicator-light buzzer-indicator"
                id="buzzerIndicator"
              >
                <i class="fas fa-volume-up"></i>
              </div>
              <div>Buzzer Status</div>
            </div>
          </div>
        </div>

        <!-- Chart Card -->
        <div class="card card-full">
          <h2>
            <i class="fas fa-chart-area"></i> Grafik Detak Jantung Real-time
          </h2>
          <div class="chart-container">
            <canvas id="bpmChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Konfigurasi Chart.js
      let ctx = document.getElementById("bpmChart").getContext("2d");
      let bpmData = [];
      let labelData = [];
      let allBpmValues = [];

      let bpmChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labelData,
          datasets: [
            {
              label: "Detak Jantung (BPM)",
              data: bpmData,
              borderColor: "#e74c3c",
              backgroundColor: "rgba(231, 76, 60, 0.1)",
              borderWidth: 3,
              tension: 0.4,
              fill: true,
              pointRadius: 4,
              pointBackgroundColor: "#e74c3c",
              pointBorderColor: "#fff",
              pointBorderWidth: 2,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 750,
          },
          scales: {
            y: {
              beginAtZero: false,
              min: 40,
              max: 150,
              ticks: {
                stepSize: 10,
              },
              grid: {
                color: "rgba(0, 0, 0, 0.05)",
              },
            },
            x: {
              grid: {
                color: "rgba(0, 0, 0, 0.05)",
              },
            },
          },
          plugins: {
            legend: {
              display: true,
              position: "top",
            },
          },
        },
      });

      // Fungsi untuk menentukan status detak jantung
      function getHeartRateStatus(bpm) {
        if (bpm < 60) {
          return {
            status: "Rendah (Bradikardia)",
            class: "status-low",
            led: false,
            buzzer: false,
          };
        } else if (bpm >= 60 && bpm <= 100) {
          return {
            status: "Normal",
            class: "status-normal",
            led: false,
            buzzer: false,
          };
        } else if (bpm > 100 && bpm <= 120) {
          return {
            status: "Tinggi",
            class: "status-high",
            led: true,
            buzzer: false,
          };
        } else {
          return {
            status: "Bahaya (Takikardia)",
            class: "status-danger",
            led: true,
            buzzer: true,
          };
        }
      }

      // Fungsi untuk memperbarui statistik
      function updateStatistics() {
        if (allBpmValues.length === 0) return;

        let min = Math.min(...allBpmValues);
        let max = Math.max(...allBpmValues);
        let avg = Math.round(
          allBpmValues.reduce((a, b) => a + b, 0) / allBpmValues.length
        );

        document.getElementById("minBpm").textContent = min;
        document.getElementById("maxBpm").textContent = max;
        document.getElementById("avgBpm").textContent = avg;
        document.getElementById("totalData").textContent = allBpmValues.length;
      }

      // Fungsi untuk memuat data dari server
      function loadData() {
        fetch("http://10.229.1.250:5000/data")
          .then((res) => {
            if (!res.ok) throw new Error("Network error");
            return res.json();
          })
          .then((data) => {
            // Update status koneksi
            let statusElem = document.getElementById("connectionStatus");
            statusElem.className = "connection-status connected";
            statusElem.innerHTML =
              '<i class="fas fa-check-circle"></i> Terhubung';

            if (data.status !== "NO DATA") {
              let bpm = data.bpm;
              let waktu = data.waktu;

              // Update angka BPM
              document.getElementById("bpmValue").textContent = bpm;
              document.getElementById("waktu").textContent =
                "Terakhir update: " + waktu;

              // Update status
              let hrStatus = getHeartRateStatus(bpm);
              let statusBox = document.getElementById("statusBox");
              statusBox.textContent = hrStatus.status;
              statusBox.className = "status-box " + hrStatus.class;

              // Update LED dan Buzzer indicator
              let ledIndicator = document.getElementById("ledIndicator");
              let buzzerIndicator = document.getElementById("buzzerIndicator");

              if (hrStatus.led) {
                ledIndicator.classList.add("on");
              } else {
                ledIndicator.classList.remove("on");
              }

              if (hrStatus.buzzer) {
                buzzerIndicator.classList.add("on");
              } else {
                buzzerIndicator.classList.remove("on");
              }

              // Tambah data ke grafik
              let waktuLabel = waktu.split(" ")[1]; // hanya jam

              // Cek apakah data baru (tidak duplikat)
              if (
                labelData.length === 0 ||
                labelData[labelData.length - 1] !== waktuLabel
              ) {
                bpmData.push(bpm);
                labelData.push(waktuLabel);
                allBpmValues.push(bpm);

                // Maksimal 30 data biar grafik tidak kepanjangan
                if (bpmData.length > 30) {
                  bpmData.shift();
                  labelData.shift();
                }

                // Maksimal 100 data untuk statistik
                if (allBpmValues.length > 100) {
                  allBpmValues.shift();
                }

                bpmChart.update();
                updateStatistics();
              }
            }
          })
          .catch((err) => {
            console.log("Error:", err);
            let statusElem = document.getElementById("connectionStatus");
            statusElem.className = "connection-status disconnected";
            statusElem.innerHTML =
              '<i class="fas fa-exclamation-circle"></i> Terputus';
          });
      }

      // Muat data setiap 1 detik
      setInterval(loadData, 1000);
      loadData();
    </script>
  </body>
</html>
