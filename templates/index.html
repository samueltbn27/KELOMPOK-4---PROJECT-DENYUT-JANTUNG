<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Heart Monitor Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        margin: 0;
        font-family: 'Inter', Arial, sans-serif;
        background: #f6f6f8;
    }

    .container {
        display: flex;
        padding: 40px;
        gap: 40px;
    }

    /* Kartu kiri: gambar jantung */
    .left-card {
        width: 40%;
        background: white;
        padding: 30px;
        border-radius: 25px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        text-align: center;
    }

    .left-card img {
        width: 90%;
    }

    /* ===============================
       ANIMASI JANTUNG REALISTIS
       =============================== */
    @keyframes heartBeatRealistic {
        0% {
            transform: scale(1);
            filter: drop-shadow(0 0 5px rgba(255,0,0,0.2));
        }
        15% {
            transform: scale(1.12);
            filter: drop-shadow(0 0 15px rgba(255,0,0,0.45));
        }
        30% {
            transform: scale(1);
            filter: drop-shadow(0 0 6px rgba(255,0,0,0.25));
        }
        55% {
            transform: scale(1.06);
            filter: drop-shadow(0 0 12px rgba(255,0,0,0.35));
        }
        100% {
            transform: scale(1);
            filter: drop-shadow(0 0 5px rgba(255,0,0,0.2));
        }
    }

    .heart {
        animation-name: heartBeatRealistic;
        animation-timing-function: cubic-bezier(.4,0,.2,1);
        animation-iteration-count: infinite;
        animation-duration: 1s;
        transition: animation-duration 0.3s ease;
    }

    .left-card .bpm-box {
        margin-top: 20px;
        padding: 15px;
        background: #ffe5e5;
        border-radius: 15px;
        color: #b30000;
        font-size: 28px;
        font-weight: bold;
        box-shadow: inset 0 0 10px rgba(255,0,0,0.2);
    }

    /* Kartu kanan */
    .right-card {
        width: 60%;
        background: white;
        padding: 30px;
        border-radius: 25px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }

    h2 {
        margin: 0 0 20px 0;
        font-weight: 600;
    }

    .notif {
        margin-top: 20px;
        padding: 15px;
        border-radius: 12px;
        font-weight: bold;
        font-size: 16px;
        text-align: center;
    }

    .normal {
        background: #e3ffe3;
        color: #008000;
    }

    .cepat {
        background: #ffe0e0;
        color: #cc0000;
    }

    .lemah {
        background: #fff4d1;
        color: #a67800;
    }
</style>

</head>
<body>

<div class="container">

    <!-- LEFT CARD: GAMBAR JANTUNG -->
    <div class="left-card">
        <img src="{{ url_for('static', filename='asset/jantung1.png') }}" alt="Heart Image" class="heart" id="heartImg">

        <div class="bpm-box">
            <span id="bpmValue">--</span> BPM
        </div>
    </div>

    <!-- RIGHT CARD: GRAFIK BPM -->
    <div class="right-card">
        <h2>Grafik Detak Jantung (Real-Time)</h2>
        
        <canvas id="bpmChart" height="150"></canvas>

        <!-- Notifikasi kondisi -->
        <div id="notif" class="notif normal">Menunggu data...</div>

        <div style="margin-top:10px; color:gray;">
            Waktu: <span id="waktu">--:--:--</span>
        </div>
    </div>

</div>

<script>
let ctx = document.getElementById('bpmChart').getContext('2d');
let bpmData = [];
let labelData = [];

// Chart Config
let bpmChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: labelData,
        datasets: [{
            label: 'Detak Jantung',
            data: bpmData,
            borderColor: '#d62828',
            backgroundColor: 'rgba(214,40,40,0.15)',
            borderWidth: 3,
            pointRadius: 2,
            tension: 0.3
        }]
    },
    options: {
        animation: false,
        scales: {
            y: {
                beginAtZero: false
            }
        }
    }
});

// Load data dari API Python Flask
function loadData() {
    fetch("http://localhost:5000/data")
        .then(res => res.json())
        .then(data => {
            if (data.status !== "NO DATA") {

                document.getElementById("bpmValue").innerText = data.bpm;
                document.getElementById("waktu").innerText = data.waktu;

                let waktuNow = data.waktu.split(" ")[1];

                // push data grafik
                bpmData.push(data.bpm);
                labelData.push(waktuNow);

                if (bpmData.length > 20) {
                    bpmData.shift();
                    labelData.shift();
                }

                bpmChart.update();

                // === ANIMASI JANTUNG SESUAI BPM ===
                let heart = document.getElementById("heartImg");
                let bpm = data.bpm;

                let minDuration = 0.4;
                let maxDuration = 1.5;

                let duration = 60 / bpm;
                duration = Math.max(minDuration, Math.min(duration, maxDuration));

                heart.style.animationDuration = duration + "s";

                // --- NOTIFIKASI KONDISI ---
                let notif = document.getElementById("notif");

                if (data.bpm < 60) {
                    notif.className = "notif lemah";
                    notif.innerText = "Detak Jantung Lemah!";
                } 
                else if (data.bpm > 100) {
                    notif.className = "notif cepat";
                    notif.innerText = "Detak Jantung Cepat!";
                }
                else {
                    notif.className = "notif normal";
                    notif.innerText = "Detak Jantung Normal";
                }
            }
        })
        .catch(err => console.log("Error:", err));
}

setInterval(loadData, 1000);
loadData();
</script>

</body>
</html>